<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>MSP - Mercado Sui Pago</title>
  <!-- SDK da Sui -->
  <script src="https://cdn.jsdelivr.net/npm/@mysten/sui.js@0.97.0/dist/umd/sui.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px; }
    .produto { font-size: 1.2em; margin: 20px; }
    #receipt { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>üõí MSP - Mercado Sui Pago</h1>
  <div class="produto">Camisa - R$100,00</div>
  <button id="connect">Conectar Slush Wallet</button>
  <button id="pay" disabled>Pagar com SUI</button>
  <div id="status"></div>
  <div id="receipt"></div>

  <script>
    // Cliente Sui (Devnet)
    const sui = new window.sui.SuiClient({ 
      url: 'https://fullnode.devnet.sui.io'  // removido espa√ßo extra
    });

    let currentAddress = null;

    // Endere√ßo do lojista (seu endere√ßo)
    const LOJISTA = '0x91009991d46fc675f73137664e28a95ce2b7ca86c719f84b81ec40498eba45ba';

    // ID do pacote do contrato Move
    const PACKAGE_ID = '0xa2e9dea71b87668d307d82441e891b6ac36ea93959e8f46e8c6fdcbef45cb4de';

    // M√≥dulo e fun√ß√£o
    const MODULE = 'payment';
    const FUNCTION = 'pay';

    // Valor em MIST (0.1 SUI)
    const VALOR_MIST = 100000000;

    // Conectar carteira
    document.getElementById('connect').onclick = async () => {
      try {
        if (!window.sui) {
          alert("Instale a Slush Wallet");
          return;
        }
        const accounts = await window.sui.connect();
        currentAddress = accounts[0];
        document.getElementById('status').innerText = 
          '‚úÖ Conectado: ' + currentAddress.slice(0, 8) + '...';
        document.getElementById('pay').disabled = false;
      } catch (err) {
        document.getElementById('status').innerText = '‚ùå Erro ao conectar.';
      }
    };

    // Pagar com SUI (chama o contrato Move)
    document.getElementById('pay').onclick = async () => {
      if (!currentAddress) return;

      try {
        const tx = {
          packageObjectId: PACKAGE_ID,
          module: MODULE,
          function: FUNCTION,
          typeArguments: [],
          arguments: [LOJISTA, VALOR_MIST],
          gasBudget: 10000,
        };

        // Assina e executa a transa√ß√£o
        const result = await window.sui.signAndExecuteTransaction({ transaction: tx });

        // Mostra sucesso e link no explorador
        const explorerUrl = `https://suiexplorer.com/txblock/${result.digest}?network=devnet`;
        document.getElementById('receipt').innerHTML = `
          <p>‚úÖ Pagamento feito com sucesso!</p>
          <p><strong>Transa√ß√£o:</strong></p>
          <a href="${explorerUrl}" target="_blank">${result.digest}</a>
        `;

        // Opcional: envia recibo pro backend/Walrus depois
        /*
        fetch('/api/recibo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tx: result.digest, buyer: currentAddress })
        });
        */

      } catch (err) {
        document.getElementById('status').innerText = '‚ùå Erro: ' + err.message;
      }
    };
  </script>
</body>
</html>